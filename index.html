<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Alumni Portal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    form { margin-bottom: 20px; }
    .alumni-card { border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 8px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Alumni Portal</h1>

  <!-- Auth -->
  <div id="auth-section">
    <button id="login-btn">Login</button>
    <button id="logout-btn" class="hidden">Logout</button>
  </div>

  <!-- Alumni form -->
  <form id="alumni-form" class="hidden">
    <input type="text" name="name" placeholder="Full Name" required />
    <input type="text" name="batch" placeholder="Batch (e.g. 2010)" required />
    <input type="text" name="dept" placeholder="Department" required />
    <input type="text" name="company" placeholder="Company" required />
    <input type="text" name="location" placeholder="Location" required />
    <button type="submit">Add Alumni</button>
  </form>

  <!-- Search -->
  <input type="text" id="search-box" placeholder="Search alumni..." />
  <button id="search-btn">Search</button>

  <!-- Alumni list -->
  <div id="alumni-list"></div>

  <!-- Chat -->
  <h2>Messages</h2>
  <div id="messages"></div>
  <form id="chat-form" class="hidden">
    <input type="text" id="chat-input" placeholder="Type a message..." required />
    <button type="submit">Send</button>
  </form>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ðŸ”‘ Replace with your own Supabase project details
    const supabaseUrl = "https://oriswzmkjvyesqlrpbya.supabase.co";
    const supabaseKey = "YOUR_ANON_KEY"; // âš ï¸ use anon public key, not service role!
    const supabase = createClient(supabaseUrl, supabaseKey);

    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const alumniForm = document.getElementById("alumni-form");
    const alumniList = document.getElementById("alumni-list");
    const searchBox = document.getElementById("search-box");
    const searchBtn = document.getElementById("search-btn");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");
    const messagesDiv = document.getElementById("messages");

    let currentUser = null;

    // ----------------- AUTH -----------------
    async function refreshAuthState() {
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
      if (user) {
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        alumniForm.classList.remove("hidden");
        chatForm.classList.remove("hidden");
        loadAlumni();
        subscribeMessages();
      } else {
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        alumniForm.classList.add("hidden");
        chatForm.classList.add("hidden");
        alumniList.innerHTML = "";
        messagesDiv.innerHTML = "";
      }
    }

    loginBtn.addEventListener("click", async () => {
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: "google"
      });
      if (error) console.error(error);
    });

    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      refreshAuthState();
    });

    // ----------------- ALUMNI -----------------
    alumniForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(alumniForm).entries());
      const { error } = await supabase.from("alumni").insert([formData]);
      if (error) {
        alert("Error adding alumni: " + error.message);
      } else {
        alumniForm.reset();
        loadAlumni();
      }
    });

    async function loadAlumni() {
      const { data, error } = await supabase.from("alumni").select("*").order("id", { ascending: false });
      if (error) {
        console.error(error);
        return;
      }
      displayAlumni(data);
    }

    function displayAlumni(alumni) {
      alumniList.innerHTML = "";
      alumni.forEach(a => {
        const div = document.createElement("div");
        div.className = "alumni-card";
        div.innerHTML = `<strong>${a.name}</strong><br>Batch: ${a.batch} | Dept: ${a.dept}<br>${a.company}, ${a.location}`;
        alumniList.appendChild(div);
      });
    }

    searchBtn.addEventListener("click", async () => {
      const q = searchBox.value.trim();
      if (!q) return loadAlumni();
      const { data, error } = await supabase
        .from("alumni")
        .select("*")
        .or(`name.ilike.%${q}%,batch.ilike.%${q}%,dept.ilike.%${q}%,company.ilike.%${q}%,location.ilike.%${q}%`);
      if (error) {
        console.error(error);
        return;
      }
      displayAlumni(data);
    });

    // ----------------- CHAT -----------------
    async function subscribeMessages() {
      if (!currentUser) return;
      const channel = supabase.channel("messages")
        .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, payload => {
          appendMessage(payload.new);
        })
        .subscribe();

      loadMessages();
    }

    async function loadMessages() {
      const { data, error } = await supabase.from("messages").select("*").order("id", { ascending: true });
      if (!error && data) {
        messagesDiv.innerHTML = "";
        data.forEach(m => appendMessage(m));
      }
    }

    function appendMessage(msg) {
      const div = document.createElement("div");
      div.textContent = `${msg.sender || "Anon"}: ${msg.content}`;
      messagesDiv.appendChild(div);
    }

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      const text = chatInput.value.trim();
      if (!text) return;
      const { error } = await supabase.from("messages").insert([{ sender: currentUser.email, content: text }]);
      if (!error) chatInput.value = "";
    });

    // ----------------- INIT -----------------
    supabase.auth.onAuthStateChange(() => refreshAuthState());
    refreshAuthState();
  </script>
</body>
</html>
