<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alumni Connect Platform</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }

    /* Dark Mode Styles */
    body.dark-mode { background-color: #121212; color: #e0e0e0; }
    body.dark-mode a { color: #9ad1ff; }
    body.dark-mode .navbar { background-color: #1f1f1f !important; }
    body.dark-mode input, body.dark-mode textarea { background-color: #1f1f1f; color: #e0e0e0; border-color: #333; }
    body.dark-mode .bg-white { background-color: #1f1f1f !important; }

    body.dark-mode #home { background-color: #2d3748; }
    body.dark-mode #home h2, body.dark-mode #home p { color: #e0e0e0; }

    body.dark-mode #directory { background-color: #1a1a1a; }
    body.dark-mode #events { background-color: #222222; }
    body.dark-mode #donations { background-color: #1a1a1a; }

    /* Smooth Transitions Globally */
    * { transition: all 0.3s ease; }

    /* Card Hover Effect */
    .shadow-lg:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
    body.dark-mode .shadow-lg:hover { box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5); }

    /* Scroll animations */
    .fade-in { opacity: 0; transform: translateY(20px); transition: opacity 0.8s ease-out, transform 0.8s ease-out; }
    .fade-in.visible { opacity: 1; transform: translateY(0); }

    /* Text Animations for headings */
    h3 { position: relative; overflow: hidden; }
    h3::after {
      content: '';
      position: absolute;
      width: 0;
      height: 3px;
      bottom: 0;
      left: 0;
      background-color: #4f46e5;
      transition: width 0.5s ease;
    }
    h3:hover::after { width: 100%; }

    /* Improved Input Focus */
    input:focus, textarea:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 5px rgba(79, 70, 229, 0.5); }

    /* Hero / holographic animation */
    #hero-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 85vh; overflow: hidden; position: relative; }
    @media (min-width: 768px) { #hero-container { flex-direction: row; } }
    #hero-text-content { z-index: 10; }
    #animated-logo-container { position: relative; perspective: 1500px; display: flex; justify-content: center; align-items: center; }
    #company-logo { width: 100%; max-width: 350px; height: auto; opacity: 0; transform: rotateY(-45deg) scale(0.5); animation: holographic-reveal 3s forwards 0.5s; }

    #animated-logo-container::before {
      content: '';
      position: absolute;
      bottom: 40px;
      width: 400px;
      height: 80px;
      background: radial-gradient(ellipse at center, rgba(79, 70, 229, 0.4) 0%, rgba(79, 70, 229, 0) 70%);
      border-radius: 50%;
      transform: rotateX(80deg);
      animation: projector-glow 4s infinite alternate;
    }

    #animated-logo-container::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: #93c5fd;
      border-radius: 2px;
      box-shadow: 0 0 10px #93c5fd, 0 0 20px white;
      animation: scan-lines 4s cubic-bezier(0.23, 1, 0.32, 1) infinite;
      animation-delay: 3.5s;
    }

    @keyframes holographic-reveal {
      0% { opacity: 0; filter: blur(20px); transform: rotateY(-45deg) scale(0.5) translateY(100px); }
      50% { opacity: 0.8; filter: blur(8px); }
      100% { opacity: 1; filter: blur(0); transform: rotateY(0deg) scale(1) translateY(0); }
    }
    @keyframes projector-glow {
      from { opacity: 0.6; transform: rotateX(80deg) scale(0.9); }
      to { opacity: 1; transform: rotateX(80deg) scale(1.1); }
    }
    @keyframes scan-lines {
      0% { transform: translateY(0); opacity: 0; }
      5% { opacity: 1; }
      95% { opacity: 1; }
      100% { transform: translateY(350px); opacity: 0; }
    }

    /* hide the directory grid by default to prevent mass exposure of alumni */
    #directory .grid { display: none; /* Hidden until a search is made */ }

    /* chat styles */
    .chat-container { height: 400px; overflow-y: auto; }
    .message { padding: 0.5rem 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; display: inline-block; max-width: 85%; }
    .message.me { background-color: #e0f2fe; align-self: flex-end; }
    .message.them { background-color: #f1f5f9; align-self: flex-start; }

    /* small responsive tweaks */
    @media (max-width: 640px) {
      .navbar .hidden.md\\:flex { display: none !important; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-300">

  <nav class="navbar flex items-center justify-between p-4 bg-blue-600 text-white shadow-md sticky top-0 z-50">
    <h1 class="text-2xl font-bold">Alumni Connect</h1>
    <div class="space-x-6 hidden md:flex">
      <a href="#home" class="hover:underline">Home</a>
      <a href="#alumni" class="hover:underline">Alumni</a>
      <a href="#directory" class="hover:underline">Directory</a>
      <a href="#networking" class="hover:underline">Networking</a>
      <a href="#events" class="hover:underline">Events</a>
      <a href="#mentorship" class="hover:underline">Mentorship</a>
      <a href="#donations" class="hover:underline">Donations</a>
    </div>

    <div class="flex items-center gap-4">
      <div id="auth-status" class="text-sm hidden md:block">Not signed in</div>
      <button id="openAuthBtn" class="px-3 py-1 bg-white text-blue-600 rounded hover:opacity-90">Sign up / Log in</button>
      <button id="darkModeToggle" class="px-4 py-2 bg-gray-900 rounded-lg hover:bg-gray-700 text-sm">
        🌙 Dark Mode
      </button>
    </div>
  </nav>

  <section id="home" class="bg-gray-200 text-gray-800 fade-in">
    <div id="hero-container" class="max-w-7xl mx-auto px-6">
      <div id="hero-text-content" class="text-center md:text-left md:w-1/2 md:pr-12">
        <h2 class="text-4xl lg:text-5xl font-bold mb-4">Stay Connected. Empower the Future.</h2>
        <p class="text-lg mb-6">Centralized alumni management with networking, mentorship, events, and career support.</p>
        <a href="#alumni" class="inline-block px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transform hover:scale-105">
          Get Started
        </a>
      </div>
      <div id="animated-logo-container" class="w-full md:w-1/2 mt-12 md:mt-0">
        <img src="assets/logo.jpeg" alt="Company Logo" id="company-logo" />
      </div>
    </div>
  </section>

  <section id="alumni" class="max-w-5xl mx-auto py-12 px-6 fade-in">
    <h3 class="text-2xl font-bold mb-6 border-b pb-2">Alumni Registration & Profiles</h3>
    <form id="alumni-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-white p-6 rounded-xl shadow-lg">
      <input type="text" id="alumni-name" placeholder="Full Name" class="p-3 border rounded" />
      <input type="email" id="alumni-email" placeholder="Email (Mandatory)" class="p-3 border rounded" />
      <input type="text" id="alumni-batch" placeholder="Batch" class="p-3 border rounded" />
      <input type="text" id="alumni-dept" placeholder="Department" class="p-3 border rounded" />
      <input type="text" id="alumni-role" placeholder="Current Job Title" class="p-3 border rounded" />
      <input type="text" id="alumni-company" placeholder="Company" class="p-3 border rounded" />
      <input type="text" id="alumni-location" placeholder="Location (e.g., City, Country)" class="p-3 border rounded" />
      <input type="file" id="alumni-photo" class="p-3 border rounded col-span-2" accept="image/*" />
      <button id="alumni-submit" type="submit" class="col-span-2 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Register</button>
    </form>
  </section>

  <section id="directory" class="bg-gray-100 py-12 px-6 fade-in">
    <div class="max-w-5xl mx-auto">
      <h3 class="text-2xl font-bold mb-6 border-b pb-2">Centralized Alumni Directory</h3>

      <input id="directorySearchInput" type="text" placeholder="Search alumni by name, batch, department..." class="w-full p-3 border rounded mb-6" />

      <div class="flex items-center gap-3 mb-4">
        <button id="directorySearchBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Search</button>
        <button id="clearSearchBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded">Clear</button>
        <div class="text-sm text-gray-600 ml-4">Only search results are shown — all alumni data is private by default.</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- directory grid items will be injected here -->
      </div>
    </div>
  </section>

  <section id="networking" class="max-w-5xl mx-auto py-12 px-6 fade-in">
    <h3 class="text-2xl font-bold mb-6 border-b pb-2">Communication & Networking</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h4 class="font-semibold text-lg">Messaging System</h4>
        <p class="text-sm mt-2">Send direct messages to alumni and students securely.</p>
        <button id="openChatBtn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded">Open Chat</button>

        <div id="chatPanel" class="mt-4 hidden">
          <div class="flex gap-4">
            <div class="w-1/3 border p-3 rounded">
              <input id="chatUserSearch" placeholder="Search alumni to chat..." class="w-full p-2 border rounded mb-3" />
              <div id="chatUserList" class="space-y-2 max-h-56 overflow-y-auto">
              </div>
            </div>
            <div class="w-2/3 border p-3 rounded flex flex-col">
              <div id="chatMessages" class="chat-container mb-3 flex flex-col">
              </div>
              <div class="flex gap-2">
                <input id="chatMessageInput" placeholder="Type a message..." class="flex-1 p-2 border rounded" />
                <button id="sendChatBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Send</button>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h4 class="font-semibold text-lg">Discussion Forums</h4>
        <p class="text-sm mt-2">Join batch-wise or industry-wise groups and discussions.</p>
        <button id="openForumsBtn" class="mt-4 px-4 py-2 bg-green-600 text-white rounded">Browse Forums</button>

        <div id="forumPanel" class="mt-4 hidden">
          <div class="flex gap-4">
            <div class="w-1/3 border p-3 rounded">
              <h5 class="font-semibold mb-2">Forums</h5>
              <ul id="forumList" class="space-y-2">
                <li class="p-2 border rounded cursor-pointer" data-forum="general">General</li>
                <li class="p-2 border rounded cursor-pointer" data-forum="jobs">Jobs & Careers</li>
                <li class="p-2 border rounded cursor-pointer" data-forum="reunions">Reunions</li>
              </ul>
            </div>

            <div class="w-2/3 border p-3 rounded flex flex-col">
              <div id="forumThreads" class="mb-3 space-y-3 overflow-y-auto" style="max-height:320px;">
                <div class="p-3 border rounded">Select a forum to view threads.</div>
              </div>

              <textarea id="newThreadInput" placeholder="Start a new thread in this forum..." class="p-2 border rounded mb-2"></textarea>
              <div class="flex justify-end">
                <button id="postThreadBtn" class="px-4 py-2 bg-green-600 text-white rounded">Post Thread</button>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </section>

  <section id="events" class="bg-gray-100 py-12 px-6 fade-in">
    <div class="max-w-5xl mx-auto">
      <h3 class="text-2xl font-bold mb-6 border-b pb-2">Events & Networking</h3>
      <button id="createEventBtn" class="mb-6 bg-blue-600 text-white px-4 py-2 rounded">+ Create Event</button>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h4 class="text-xl font-semibold">Annual Reunion 2025</h4>
          <p class="text-sm mt-2">Join your batchmates for a grand reunion in campus!</p>
          <button class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">RSVP</button>
        </div>
      </div>
    </div>
  </section>

  <section id="mentorship" class="max-w-5xl mx-auto py-12 px-6 fade-in">
    <h3 class="text-2xl font-bold mb-6 border-b pb-2">Mentorship & Career Support</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h4 class="text-xl font-semibold">Become a Mentor</h4>
        <p class="mt-2 text-sm">Volunteer to guide students and junior alumni in their career paths.</p>
        <button id="becomeMentorBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded">Sign Up</button>
      </div>
    </div>
  </section>

  <section id="donations" class="bg-gray-100 py-12 px-6 fade-in">
    <div class="max-w-5xl mx-auto">
      <h3 class="text-2xl font-bold mb-6 border-b pb-2">Fundraising & Donations</h3>
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <p class="text-sm">Support your alma mater’s growth. Transparent reports of all contributions.</p>
        <button id="donateBtn" class="mt-4 bg-purple-600 text-white px-6 py-2 rounded-lg">Donate Now</button>
      </div>
    </div>
  </section>

  <footer class="text-center py-6 bg-blue-600 text-white fade-in">
    <p>&copy; 2025 Alumni Connect | Built with ❤️ for SIH</p>
  </footer>

  <!-- Auth modal container will be injected by JS -->

  <!-- MAIN SCRIPT: Use module import for supabase v2 (ESM) -->
  <script type="module">
    /*
      IMPORTANT:
      - Replace REPLACE_WITH_YOUR_ANON_KEY with your Supabase project's anon public key (not service role).
      - Keep your anon key private-ish (do not commit to public repos). The service role key must NEVER be used on frontend.
      - This script assumes the following tables (and simple columns) exist in Supabase:
        - alumni (id, name, email, batch, dept, role, company, location, photo_url)
        - messages (id, from_id, to_id, content, inserted_at)
        - forum_threads (id, forum, title, body, author_id, inserted_at)
    */

    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://oriswzmkjvyesqlrpbya.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yaXN3em1ranZ5ZXNxbHJwYnlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MzA4OTMsImV4cCI6MjA3MzUwNjg5M30.YH3JEbMDL0r8FvmQ-KJtrKCVmJo5RslUKq90FkICvAE"; // <<-- replace this with your anon public key

    // Create global supabase client
    const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window._supabase = _supabase; // expose for debugging (optional)

    // ----------------- Utilities -----------------
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function el(selector) { return document.querySelector(selector); }
    function els(selector) { return Array.from(document.querySelectorAll(selector)); }

    // ----------------- AUTH UI -----------------
    const openAuthBtn = el('#openAuthBtn');
    const authStatusEl = el('#auth-status');
    const darkModeToggle = el('#darkModeToggle');

    // build auth modal HTML and inject
    const authModalHtml = `
      <div id="authOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-60 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Sign in / Sign up</h3>
            <button id="closeAuth" class="text-gray-600">✕</button>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <h4 class="font-semibold mb-2">Create account</h4>
              <input id="signupEmail" type="email" placeholder="Email" class="w-full p-2 border rounded mb-2" />
              <input id="signupPassword" type="password" placeholder="Password" class="w-full p-2 border rounded mb-2" />
              <button id="signupBtn" class="w-full bg-blue-600 text-white py-2 rounded">Create account</button>
            </div>
            <div>
              <h4 class="font-semibold mb-2">Sign in</h4>
              <input id="signinEmail" type="email" placeholder="Email" class="w-full p-2 border rounded mb-2" />
              <input id="signinPassword" type="password" placeholder="Password" class="w-full p-2 border rounded mb-2" />
              <button id="signinBtn" class="w-full bg-green-600 text-white py-2 rounded">Sign in</button>
              <button id="magicLinkBtn" class="w-full mt-2 bg-gray-200 text-gray-800 py-2 rounded">Send magic link</button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', authModalHtml);
    const authOverlay = el('#authOverlay');
    el('#closeAuth').addEventListener('click', () => { authOverlay.classList.add('hidden'); });
    openAuthBtn.addEventListener('click', () => { authOverlay.classList.remove('hidden'); });

    // ----------------- Dark Mode Toggle -----------------
    darkModeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      darkModeToggle.textContent = document.body.classList.contains('dark-mode') ? "☀️ Light Mode" : "🌙 Dark Mode";
    });

    // ----------------- Page Fade-in Observer -----------------
    const fadeElems = document.querySelectorAll('.fade-in');
    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) entry.target.classList.add('visible');
      });
    }, { threshold: 0.1 });
    fadeElems.forEach(elm => observer.observe(elm));

    // ----------------- ALUMNI - load & register -----------------
    async function loadAlumni() {
      try {
        const { data, error } = await _supabase.from('alumni').select('*').order('id', { ascending: false }).limit(200);
        if (error) {
          console.error('Error loading alumni:', error);
          return;
        }
        const container = document.querySelector('#directory .grid');
        container.innerHTML = '';
        if (!data || data.length === 0) {
          // keep hidden (no results)
          return;
        }
        // show grid
        container.style.display = 'grid';
        const cardsHtml = data.map(a => `
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <img src="${escapeHtml(a.photo_url || 'https://via.placeholder.com/100')}" alt="profile" class="w-20 h-20 rounded-full mb-3 object-cover" />
            <h4 class="text-lg font-semibold">${escapeHtml(a.name || '(no name)')}</h4>
            <p class="text-sm text-gray-500">Batch: ${escapeHtml(a.batch || 'N/A')} | Dept: ${escapeHtml(a.dept || 'N/A')}</p>
            <p class="text-sm mt-2">${escapeHtml(a.role || 'Role not specified')} @ ${escapeHtml(a.company || 'Company not specified')}</p>
            <p class="text-sm mt-3 text-gray-700"><strong>Location:</strong> ${escapeHtml(a.location || '—')}</p>
          </div>
        `).join('');
        container.innerHTML = cardsHtml;
      } catch (err) {
        console.error('Unexpected error loading alumni', err);
      }
    }

    // alumni form handling
    const alumniForm = el('#alumni-form');
    alumniForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = {
        name: el('#alumni-name').value.trim(),
        email: el('#alumni-email').value.trim(),
        batch: el('#alumni-batch').value.trim(),
        dept: el('#alumni-dept').value.trim(),
        role: el('#alumni-role').value.trim(),
        company: el('#alumni-company').value.trim(),
        location: el('#alumni-location').value.trim(),
      };

      // simple validation
      if (!formData.email) {
        alert('Email is required.');
        return;
      }

      // Photo upload (optional) - attempt to upload to Supabase Storage if available
      const photoInput = el('#alumni-photo');
      if (photoInput && photoInput.files && photoInput.files[0]) {
        try {
          const file = photoInput.files[0];
          const fileExt = file.name.split('.').pop();
          const fileName = `${Date.now()}.${fileExt}`;
          // Ensure you have a bucket named 'public' or change the bucket name accordingly
          const { data: uploadData, error: uploadError } = await _supabase.storage.from('public').upload(`alumni/${fileName}`, file, { upsert: false });
          if (!uploadError && uploadData?.path) {
            const { data: publicUrlData } = await _supabase.storage.from('public').getPublicUrl(uploadData.path);
            formData.photo_url = publicUrlData.publicUrl;
          } else {
            console.warn('Photo upload skipped or failed:', uploadError);
          }
        } catch (uploadErr) {
          console.warn('Photo upload error (continuing without photo):', uploadErr);
        }
      }

      const { data, error } = await _supabase.from('alumni').insert([formData]);
      if (error) {
        console.error('Insert error:', error);
        alert('Failed to register alumni. Check console for details.');
      } else {
        alert('Alumni registered successfully!');
        alumniForm.reset();
        loadAlumni();
      }
    });

    // ----------------- DIRECTORY SEARCH -----------------
    const directorySearchInput = el('#directorySearchInput');
    const directoryGrid = document.querySelector('#directory .grid');
    const directorySearchBtn = el('#directorySearchBtn');
    const clearSearchBtn = el('#clearSearchBtn');

    function showDirectoryResults(cardsHtml) {
      directoryGrid.style.display = 'grid';
      directoryGrid.innerHTML = cardsHtml || '<div class="col-span-3 bg-white p-6 rounded-xl shadow-lg">No results found.</div>';
    }
    function hideDirectoryResults() {
      directoryGrid.style.display = 'none';
      directoryGrid.innerHTML = '';
    }

    hideDirectoryResults();

    async function searchAlumni(query) {
      if (!query || query.trim().length === 0) {
        alert('Enter a search term (name, batch, department, company or location).');
        return;
      }
      const q = query.trim();

      // safer .or() usage (comma-separated list)
      const filter = `name.ilike.%${q}%,batch.ilike.%${q}%,dept.ilike.%${q}%,company.ilike.%${q}%,location.ilike.%${q}%`;

      const { data, error } = await _supabase
        .from('alumni')
        .select('id, name, batch, dept, role, company, location, email, photo_url')
        .or(filter)
        .limit(50);

      if (error) {
        console.error('Search error:', error);
        alert('Search failed — check console for details.');
        return;
      }

      if (!data || data.length === 0) {
        showDirectoryResults('<div class="col-span-3 bg-white p-6 rounded-xl shadow-lg">No matching alumni found.</div>');
        return;
      }

      const cards = data.map(alumni => `
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <img src="${escapeHtml(alumni.photo_url || 'https://via.placeholder.com/100')}" alt="profile" class="w-20 h-20 rounded-full mb-3 object-cover" />
          <h4 class="text-lg font-semibold">${escapeHtml(alumni.name || 'Unknown')}</h4>
          <p class="text-sm text-gray-500">Batch: ${escapeHtml(alumni.batch || 'N/A')} | Dept: ${escapeHtml(alumni.dept || 'N/A')}</p>
          <p class="text-sm mt-2">${escapeHtml(alumni.role || 'Role not specified')} @ ${escapeHtml(alumni.company || 'Company not specified')}</p>
          <p class="text-sm mt-3 text-gray-700"><strong>Location:</strong> ${escapeHtml(alumni.location || '—')}</p>
          <div class="mt-3 flex gap-2">
            <button class="openProfileBtn px-3 py-1 bg-blue-600 text-white rounded" data-id="${alumni.id}">View / Message</button>
            <button class="connectBtn px-3 py-1 bg-green-600 text-white rounded" data-id="${alumni.id}">Connect</button>
          </div>
        </div>
      `).join('');

      showDirectoryResults(cards);

      // attach event listeners to newly created buttons
      document.querySelectorAll('.openProfileBtn').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          const id = btn.getAttribute('data-id');
          openChatWithUserId(id);
        });
      });

      document.querySelectorAll('.connectBtn').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          alert('Connect request UI placeholder — backend invite/connection logic can be implemented next.');
        });
      });
    }

    directorySearchBtn.addEventListener('click', () => {
      const q = directorySearchInput.value;
      searchAlumni(q);
    });
    directorySearchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchAlumni(directorySearchInput.value);
      }
    });
    clearSearchBtn.addEventListener('click', () => {
      directorySearchInput.value = '';
      hideDirectoryResults();
    });

    // ----------------- AUTH ACTIONS -----------------
    el('#signupBtn').addEventListener('click', async () => {
      const email = el('#signupEmail').value;
      const password = el('#signupPassword').value;
      if (!email || !password) { alert('Enter email & password'); return; }

      const { data, error } = await _supabase.auth.signUp({ email, password });
      if (error) { console.error('Sign up error', error); alert('Sign up failed — check console.'); return; }
      alert('Sign up initiated. Check your email for confirmation if required by Supabase settings.');
      authOverlay.classList.add('hidden');
      refreshAuthState();
    });

    el('#signinBtn').addEventListener('click', async () => {
      const email = el('#signinEmail').value;
      const password = el('#signinPassword').value;
      if (!email || !password) { alert('Enter email & password'); return; }

      const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
      if (error) { console.error('Sign in error', error); alert('Sign in failed — check console.'); return; }
      alert('Signed in!');
      authOverlay.classList.add('hidden');
      refreshAuthState();
    });

    el('#magicLinkBtn').addEventListener('click', async () => {
      const email = el('#signinEmail').value || el('#signupEmail').value;
      if (!email) { alert('Enter email for magic link'); return; }
      const { data, error } = await _supabase.auth.signInWithOtp({ email });
      if (error) { console.error('Magic link error', error); alert('Failed to send magic link.'); return; }
      alert('Magic link sent to email.');
    });

    // ----------------- AUTH STATE REFRESH -----------------
    async function refreshAuthState() {
      try {
        const { data: { user } } = await _supabase.auth.getUser();
        if (user) {
          authStatusEl.textContent = `Signed in as ${user.email}`;
          authStatusEl.classList.remove('hidden');
          openAuthBtn.textContent = 'Account';
          if (!el('#logoutBtn')) {
            const logoutBtn = document.createElement('button');
            logoutBtn.id = 'logoutBtn';
            logoutBtn.className = 'px-3 py-1 bg-white text-blue-600 rounded hover:opacity-90 ml-2';
            logoutBtn.textContent = 'Logout';
            logoutBtn.addEventListener('click', async () => {
              await _supabase.auth.signOut();
              refreshAuthState();
              alert('Signed out.');
            });
            openAuthBtn.insertAdjacentElement('afterend', logoutBtn);
          }
        } else {
          authStatusEl.textContent = 'Not signed in';
          openAuthBtn.textContent = 'Sign up / Log in';
          const logoutBtn = el('#logoutBtn');
          if (logoutBtn) logoutBtn.remove();
        }
      } catch (err) {
        console.error('Failed to refresh auth state', err);
      }
    }

    // Keep auth state updated
    _supabase.auth.onAuthStateChange((event, session) => {
      // event could be "SIGNED_IN", "SIGNED_OUT", etc.
      refreshAuthState();
    });

    // Initial refresh (on load)
    (async () => {
      await refreshAuthState();
      // Don't automatically load all alumni (privacy) — only load after search or explicit view
      // But you can load a summary if you want:
      // await loadAlumni();
    })();

    // ----------------- CHAT / MESSAGING -----------------
    const openChatBtn = el('#openChatBtn');
    const chatPanel = el('#chatPanel');
    const chatUserList = el('#chatUserList');
    const chatUserSearch = el('#chatUserSearch');
    const chatMessages = el('#chatMessages');
    const chatMessageInput = el('#chatMessageInput');
    const sendChatBtn = el('#sendChatBtn');

    let currentChatUserId = null;
    let currentUser = null;
    const messagesSubscriptionRefs = [];

    openChatBtn.addEventListener('click', async () => {
      chatPanel.classList.toggle('hidden');
      if (!chatPanel.classList.contains('hidden')) {
        chatUserList.innerHTML = '<div class="text-sm text-gray-600">Search alumni to start a chat</div>';
      }
    });

    chatUserSearch.addEventListener('keydown', async (e) => {
      if (e.key !== 'Enter') return;
      const q = chatUserSearch.value.trim();
      if (!q) return;
      const { data, error } = await _supabase
        .from('alumni')
        .select('id, name, email, batch, dept')
        .or(`name.ilike.%${q}%,email.ilike.%${q}%`)
        .limit(30);
      if (error) { console.error(error); chatUserList.innerHTML = '<div class="text-red-600">Search failed</div>'; return; }
      if (!data || data.length === 0) { chatUserList.innerHTML = '<div class="text-sm text-gray-600">No users found</div>'; return; }

      chatUserList.innerHTML = data.map(u => `
        <div class="p-2 border rounded cursor-pointer chat-user-item" data-id="${u.id}" data-name="${escapeHtml(u.name || '')}">
          <div class="font-semibold">${escapeHtml(u.name || '(no name)')}</div>
          <div class="text-xs text-gray-600">Batch: ${escapeHtml(u.batch || '—')} • ${escapeHtml(u.dept || '—')}</div>
        </div>
      `).join('');

      document.querySelectorAll('.chat-user-item').forEach(item => {
        item.addEventListener('click', () => {
          const id = item.getAttribute('data-id');
          openChatWithUserId(id);
        });
      });
    });

    async function openChatWithUserId(userId) {
      currentChatUserId = userId;
      chatMessages.innerHTML = '<div class="text-sm text-gray-600">Loading messages...</div>';

      const { data: authData } = await _supabase.auth.getUser();
      currentUser = authData?.user || null;

      if (!currentUser) {
        chatMessages.innerHTML = '<div class="text-sm text-yellow-600">You are not signed in. Log in to send messages.</div>';
      }

      let messagesQuery;
      if (currentUser) {
        // load messages between the two users
        messagesQuery = _supabase
          .from('messages')
          .select('id, from_id, to_id, content, inserted_at')
          .or(`and(from_id.eq.${currentUser.id},to_id.eq.${userId}),and(from_id.eq.${userId},to_id.eq.${currentUser.id})`)
          .order('inserted_at', { ascending: true })
          .limit(200);
      } else {
        // guest: load messages to the selected user (read-only)
        messagesQuery = _supabase
          .from('messages')
          .select('id, from_id, to_id, content, inserted_at')
          .or(`to_id.eq.${userId}`)
          .order('inserted_at', { ascending: true })
          .limit(200);
      }

      const { data: msgs, error } = await messagesQuery;
      if (error) {
        console.warn('Could not load messages (maybe table missing):', error);
        chatMessages.innerHTML = '<div class="text-sm text-gray-600">No messages available (table may not exist).</div>';
        return;
      }

      renderMessages(msgs || []);

      // clean up previous subscriptions
      if (messagesSubscriptionRefs.length) {
        messagesSubscriptionRefs.forEach(r => {
          try { _supabase.removeChannel?.(r); } catch(e) {}
        });
        messagesSubscriptionRefs.length = 0;
      }

      // subscribe to realtime inserts on messages table
      try {
        // use a channel name unique to the conversation
        const channel = _supabase.channel(`messages:private:${userId}`);
        channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' },
          (payload) => {
            const newMsg = payload.new;
            if (!newMsg) return;
            const relevant = (newMsg.from_id === currentUser?.id && newMsg.to_id === parseInt(userId)) ||
                             (newMsg.from_id === parseInt(userId) && newMsg.to_id === currentUser?.id);
            if (relevant) {
              appendMessageToChat(newMsg, newMsg.from_id === currentUser?.id ? 'me' : 'them');
            }
          }
        );
        await channel.subscribe();
        messagesSubscriptionRefs.push(channel);
      } catch (e) {
        // fallback older subscribe API (if used)
        try {
          const sub = _supabase
            .from(`messages`)
            .on('INSERT', payload => {
              const newMsg = payload.new;
              if (!newMsg) return;
              const relevant = (newMsg.from_id === currentUser?.id && newMsg.to_id === parseInt(userId)) ||
                                (newMsg.from_id === parseInt(userId) && newMsg.to_id === currentUser?.id);
              if (relevant) appendMessageToChat(newMsg, newMsg.from_id === currentUser?.id ? 'me' : 'them');
            })
            .subscribe();
          messagesSubscriptionRefs.push(sub);
        } catch (err) {
          console.warn('Realtime subscribe not available:', err);
        }
      }
    }

    function renderMessages(msgs) {
      if (!msgs || msgs.length === 0) {
        chatMessages.innerHTML = '<div class="text-sm text-gray-600">No messages yet. Start the conversation!</div>';
        return;
      }
      chatMessages.innerHTML = '';
      msgs.forEach(m => {
        const who = (m.from_id === (currentUser?.id)) ? 'me' : 'them';
        appendMessageToChat(m, who);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function appendMessageToChat(m, who) {
      const wrap = document.createElement('div');
      wrap.className = `message ${who === 'me' ? 'me' : 'them'}`;
      const time = new Date(m.inserted_at || Date.now()).toLocaleString();
      wrap.innerHTML = `<div class="text-sm">${escapeHtml(m.content)}</div><div class="text-xs text-gray-500 mt-1">${escapeHtml(time)}</div>`;
      chatMessages.appendChild(wrap);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    sendChatBtn.addEventListener('click', async () => {
      const content = chatMessageInput.value.trim();
      if (!content) return;
      if (!currentChatUserId) { alert('Select an alumnus to message first.'); return; }

      const { data: authData } = await _supabase.auth.getUser();
      const me = authData?.user || null;
      if (!me) {
        alert('Please sign in to send messages.');
        return;
      }

      const payload = {
        from_id: me.id,
        to_id: parseInt(currentChatUserId),
        content
      };

      const { data, error } = await _supabase.from('messages').insert([payload]);
      if (error) {
        console.error('Failed to send message:', error);
        alert('Failed to send message (check console).');
        return;
      }
      chatMessageInput.value = '';
      appendMessageToChat({ ...payload, inserted_at: new Date().toISOString() }, 'me');
    });

    // ----------------- FORUMS -----------------
    const openForumsBtn = el('#openForumsBtn');
    const forumPanel = el('#forumPanel');
    const forumList = el('#forumList');
    const forumThreads = el('#forumThreads');
    const postThreadBtn = el('#postThreadBtn');
    const newThreadInput = el('#newThreadInput');

    openForumsBtn.addEventListener('click', () => {
      forumPanel.classList.toggle('hidden');
    });

    forumList.querySelectorAll('li').forEach(li => {
      li.addEventListener('click', async () => {
        const forum = li.getAttribute('data-forum');
        const { data, error } = await _supabase
          .from('forum_threads')
          .select('id, title, body, inserted_at, author_id')
          .eq('forum', forum)
          .order('inserted_at', { ascending: false })
          .limit(50);

        if (error) {
          forumThreads.innerHTML = `
            <div class="p-3 border rounded">Could not load real threads (table may not exist). Showing examples:</div>
            <div class="p-3 border rounded">Welcome to the ${escapeHtml(forum)} forum! (example thread)</div>
          `;
          return;
        }

        if (!data || data.length === 0) {
          forumThreads.innerHTML = `<div class="p-3 border rounded">No threads in ${escapeHtml(forum)} yet.</div>`;
          return;
        }

        forumThreads.innerHTML = data.map(t => `
          <div class="p-3 border rounded">
            <div class="font-semibold mb-1">${escapeHtml(t.title || 'Untitled')}</div>
            <div class="text-sm text-gray-700">${escapeHtml(t.body || '')}</div>
            <div class="text-xs text-gray-500 mt-2">${new Date(t.inserted_at).toLocaleString()}</div>
          </div>
        `).join('');
      });
    });

    postThreadBtn.addEventListener('click', async () => {
      const body = newThreadInput.value.trim();
      if (!body) { alert('Enter thread content'); return; }

      const forumEl = forumList.querySelector('li'); 
      const forum = forumEl ? forumEl.getAttribute('data-forum') : 'general';

      const { data: authData } = await _supabase.auth.getUser();
      const me = authData?.user || null;
      if (!me) {
        alert('Sign in to post threads.');
        return;
      }

      const payload = { forum, title: body.slice(0, 60), body, author_id: me.id };
      const { data, error } = await _supabase.from('forum_threads').insert([payload]);
      if (error) {
        console.warn('Failed to insert forum thread (table may not exist):', error);
        const node = document.createElement('div');
        node.className = 'p-3 border rounded';
        node.innerHTML = `<div class="font-semibold">[Local] ${escapeHtml(payload.title)}</div><div class="text-sm">${escapeHtml(payload.body)}</div>`;
        forumThreads.prepend(node);
        newThreadInput.value = '';
        alert('Thread posted locally (server insert failed).');
        return;
      }
      
      newThreadInput.value = '';
      alert('Thread posted!');
    });

    // ----------------- EVENTS / MENTORSHIP / DONATIONS (placeholders) -----------------
    el('#createEventBtn').addEventListener('click', () => {
      alert('Create Event - UI placeholder (implement backend create event flow as needed).');
    });
    el('#becomeMentorBtn').addEventListener('click', () => {
      alert('Become a Mentor - UI placeholder (implement sign-up flow).');
    });
    el('#donateBtn').addEventListener('click', () => {
      alert('Donate Now - UI placeholder (connect payment gateway to collect donations).');
    });

    // ----------------- HELPER: open chat from other areas -----------------
    function openChatWithUserIdFromSearch(userId) {
      chatPanel.classList.remove('hidden');
      openChatWithUserId(userId);
    }
    window.openChatWithUserId = openChatWithUserIdFromSearch;

    // ----------------- FINAL: On load convenience -----------------
    document.addEventListener('DOMContentLoaded', () => {
      // refreshAuthState already called on module init, but re-ensure
      refreshAuthState();
    });

    // Expose a minimal debug object for console debugging (optional)
    window.__AlumniConnectDebug = {
      supabase: _supabase,
      loadAlumni,
      searchAlumni,
      refreshAuthState,
    };

    // END module
  </script>
</body>
</html>
